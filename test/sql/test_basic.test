# name: test/sql/test_basic.test
# description: Basic unit tests for DuckSync extension
# group: [sql]

# These tests don't require external services (PostgreSQL/Snowflake)

require ducksync

# Test extension loads
statement ok
SELECT 1;

# Test total function count
# ducksync_init: 2 overloads (1-arg, 2-arg)
# ducksync_setup_storage: 2 overloads (2-arg, 3-arg)
# ducksync_add_source: 1
# ducksync_create_cache: 1
# ducksync_refresh: 1
# ducksync_query: 1
# Total: 8
query I
SELECT COUNT(*) FROM duckdb_functions() WHERE function_name LIKE 'ducksync%';
----
8

# ducksync_init has 2 overloads: (catalog_name) and (catalog_name, schema_name)
query I
SELECT COUNT(*) FROM duckdb_functions() WHERE function_name = 'ducksync_init';
----
2

# ducksync_setup_storage has 2 overloads: (pg_conn, data_path) and (pg_conn, data_path, schema_name)
query I
SELECT COUNT(*) FROM duckdb_functions() WHERE function_name = 'ducksync_setup_storage';
----
2

query I
SELECT COUNT(*) FROM duckdb_functions() WHERE function_name = 'ducksync_add_source';
----
1

query I
SELECT COUNT(*) FROM duckdb_functions() WHERE function_name = 'ducksync_create_cache';
----
1

query I
SELECT COUNT(*) FROM duckdb_functions() WHERE function_name = 'ducksync_refresh';
----
1

query I
SELECT COUNT(*) FROM duckdb_functions() WHERE function_name = 'ducksync_query';
----
1

# Verify ducksync_init overload parameter counts (includes named params)
# 1-arg overload: [col0]
# 2-arg overload: [col0, col1]
query II
SELECT function_name, length(parameters) as param_count
FROM duckdb_functions()
WHERE function_name = 'ducksync_init'
ORDER BY param_count;
----
ducksync_init	1
ducksync_init	2

# Verify ducksync_setup_storage overload parameter counts
# 2-arg overload: [col0, col1]
# 3-arg overload: [col0, col1, col2]
query II
SELECT function_name, length(parameters) as param_count
FROM duckdb_functions()
WHERE function_name = 'ducksync_setup_storage'
ORDER BY param_count;
----
ducksync_setup_storage	2
ducksync_setup_storage	3

# Test error handling - wrong number of arguments
statement error
SELECT * FROM ducksync_init();
----
No function matches

statement error
SELECT * FROM ducksync_setup_storage();
----
No function matches

statement error
SELECT * FROM ducksync_setup_storage('only_one');
----
No function matches

statement error
SELECT * FROM ducksync_add_source();
----
No function matches

statement error
SELECT * FROM ducksync_add_source('only_one');
----
No function matches

statement error
SELECT * FROM ducksync_create_cache();
----
No function matches

statement error
SELECT * FROM ducksync_create_cache('one', 'two');
----
No function matches

statement error
SELECT * FROM ducksync_refresh();
----
No function matches

statement error
SELECT * FROM ducksync_query();
----
No function matches

statement error
SELECT * FROM ducksync_query('only_one');
----
No function matches

# Test functions require initialization
statement error
SELECT * FROM ducksync_query('SELECT * FROM test', 'my_source');
----
DuckSync not initialized

statement error
SELECT * FROM ducksync_add_source('src', 'snowflake', 'my_secret');
----
DuckSync not initialized

statement error
SELECT * FROM ducksync_refresh('my_cache');
----
DuckSync not initialized
